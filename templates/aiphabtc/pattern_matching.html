{% extends 'base.html' %}
{% load static %}

{% block head %}
<style>
/* Custom style for the beta version tag */
.beta-tag {
    display: inline-block;
    padding: 6px 14px;  /* Reduced padding for a smaller box */
    background-color: #ff9900; /* Vibrant orange */
    border-radius: 12px;  /* Slightly smaller border-radius */
    font-family: 'Roboto', sans-serif;
    color: white;
    font-size: 14px;  /* Slightly smaller font size */
    font-weight: bold;
    text-transform: uppercase;
    box-shadow: 0px 3px 5px rgba(0, 0, 0, 0.1);  /* Slightly reduced shadow */
    animation: fadeIn 1s ease-in-out, bounce 0.5s infinite alternate ease-in-out;
    letter-spacing: 1px;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes bounce {
    0% {
        transform: translateY(0);
    }
    100% {
        transform: translateY(-3px);
    }
}
</style>
{% endblock %}


{% block content %}
<div class="container my-5">
    <div class="beta-tag">
        <p><strong>beta version</strong></p>
    </div>
    <br>
    <br>
    <!-- Language Toggle -->
    <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="languageToggle" id="englishLang" value="en" checked>
        <label class="form-check-label" for="englishLang">ğŸ‡ºğŸ‡¸ English</label>
    </div>
    <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="languageToggle" id="koreanLang" value="ko">
        <label class="form-check-label" for="koreanLang">ğŸ‡°ğŸ‡· Korean</label>
    </div>
    <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="chartCurrency" id="chartKrw" value="KRW" checked>
        <label class="form-check-label" for="chartKrw">BTC-KRW</label>
    </div>
    <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="chartCurrency" id="chartUsdt" value="USDT">
        <label class="form-check-label" for="chartUsdt">BTC-USDT</label>
    </div>
    <br>
    <br>
    <!-- English Section -->
    <div id="englishSection" style="display: block;">
        <h2 class="text-center mb-4">News-Based Bitcoin (BTC) Pattern Matching Analysis Tool</h2>
        <div class="alert alert-success" role="alert">
            The pattern matching tool developed by the AI Team at AIPHABTC recommends past news that is contextually similar to the input news titles and content, and displays the Bitcoin chart data (BTC-USDT; from MEXC) from the time the past news was released. The past news data is updated periodically. By default, daily chart data is shown, and it can be toggled to 30-minute chart data. ** Please note, this tool is for study and reference of Bitcoin prices only and is not an investment recommendation. Use at your own discretion **.
        </div>
        <div class="mb-3">
            <label for="topKRange_eng" class="form-label">Number of top results to retrieve (5-20):</label>
            <input type="range" class="form-range" id="topKRange_eng" name="topK" min="5" max="20" value="5">
            <span id="topKValue_eng" class="badge bg-secondary">5</span>
        </div>
        <div class="mb-4">
            <textarea id="newsText_eng" name="news_text" class="form-control" rows="4" placeholder="Enter news title and content"></textarea>
            <button type="button" id="searchButton_eng" class="btn btn-success mt-3">Search</button>
            <div id="loading_eng" class="text-center my-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden"></span>
                </div>
            </div>
            <div id="results_eng" class="mt-4"></div>
        </div>
    </div>

    <!-- Korean Section -->
    <div id="koreanSection" style="display: none;">
        <h2 class="text-center mb-4">ë‰´ìŠ¤ ê¸°ë°˜ ë¹„íŠ¸ì½”ì¸ íŒ¨í„´ë§¤ì¹­ ë¶„ì„ íˆ´</h2>
        <div class="alert alert-success" role="alert">
            ì•„ì´íŒŒë¹„íŠ¸ ì¸ê³µì§€ëŠ¥ íŒ€ì´ ê°œë°œí•œ ë‰´ìŠ¤ íŒ¨í„´ ì§€í‘œëŠ” ì…ë ¥ëœ ë‰´ìŠ¤ ì œëª©ê³¼ ë‚´ìš©ì— ë¬¸ë§¥ì ìœ¼ë¡œ ìœ ì‚¬í•œ ê³¼ê±° ë‰´ìŠ¤ë¥¼ ì¶”ì²œí•˜ê³ , í•´ë‹¹ ê³¼ê±° ë‰´ìŠ¤ê°€ ë°œí‘œëœ ì‹œì ìœ¼ë¡œë¶€í„°ì˜ ë¹„íŠ¸ì½”ì¸ ì°¨íŠ¸ ë°ì´í„° (BTC-KRW; ì—…ë¹„íŠ¸ ë°ì´í„°)ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. ê³¼ê±° ë‰´ìŠ¤ ë°ì´í„°ëŠ” ê°€ëŠ¥í•œ ì£¼ê¸°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ë©ë‹ˆë‹¤. ë””í´íŠ¸ë¡œ ì¼ë´‰ ì°¨íŠ¸ ë°ì´í„°ê°€ ë³´ì—¬ì§€ê³  30ë¶„ë´‰ ì°¨íŠ¸ ë°ì´í„°ë¡œ í† ê¸€ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </div>
        <div class="mb-3">
            <label for="topKRange" class="form-label">ì¡°íšŒí•  ìƒìœ„ ê²°ê³¼ ìˆ˜ (5-20):</label>
            <input type="range" class="form-range" id="topKRange" name="topK" min="5" max="20" value="5">
            <span id="topKValue" class="badge bg-secondary">5</span>
        </div>
        <div class="mb-4">
            <textarea id="newsText" name="news_text" class="form-control" rows="4" placeholder="ë‰´ìŠ¤ ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            <button type="button" id="searchButton" class="btn btn-success mt-3">ê²€ìƒ‰</button>
            <div id="loading" class="text-center my-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden"></span>
                </div>
            </div>
            <div id="results" class="mt-4"></div>
        </div>
    </div>



     <!-- English Section for Chart Pattern Matching -->
    <div id="englishChartSection" style="display: block;">
        <h2 class="text-center mb-4">Chart-Based Bitcoin (BTC) Pattern Matching Tool</h2>
        <div class="alert alert-success" role="alert">
            The chart pattern matching tool uses the Dynamic Time Warping (DTW) method to calculate and display the most similar past daily or 30-minute chart patterns to the current chart. ** Please note, this tool is for study and reference of Bitcoin prices only and is not an investment recommendation. Use at your own discretion **.
        </div>
        <!-- Add a toggle for 1D and 30M chart data -->
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="chartType" id="oneDayChart_en" value="1d" checked>
          <label class="form-check-label" for="oneDayChart_en">1-Day</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="chartType" id="thirtyMinChart_en" value="30m">
          <label class="form-check-label" for="thirtyMinChart_en">30-Minute</label>
        </div>
        <div>
            <label for="topKChartRange_en">Number of top chart results to retrieve (5-20): </label>
            <input type="range" id="topKChartRange_en" name="topKChart" min="5" max="20" value="5">
            <span id="topKChartValue_en">5</span>
        </div>
        <div>
            <div style="text-align: center;"> <!-- Added inline CSS for center alignment -->
                <p><strong>Current Chart Closing Price Movement</strong></p>
            </div>
            <div id="currentPatternInfo_en"></div>
            <div class="chart" id="currentPatternChart_en"></div>
        </div>

        <div>
            <button type="button" id="searchChartButton_en" class="btn btn-success">Search</button>
        </div>
        <br>
        <div id="chartLoading_en" class="text-center my-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden"></span>
            </div>
        </div>
        <div id="chartResults_en"></div>
    </div>

    <!-- Korean Section for Chart Pattern Matching -->
    <div id="koreanChartSection" style="display: none;">
        <h2 class="text-center mb-4">ì°¨íŠ¸ ê¸°ë°˜ ë¹„íŠ¸ì½”ì¸ íŒ¨í„´ë§¤ì¹­ ë¶„ì„ íˆ´</h2>
        <div class="alert alert-success" role="alert">
            Dynamic Time Warping (DTW) ë°©ë²•ì˜ ì°¨íŠ¸ íŒ¨í„´ ë§¤ì¹­ ë°©ë²•ìœ¼ë¡œ í˜„ì¬ ì¼ë´‰ í˜¹ì€ 30ë¶„ë´‰ êµ¬ê°„ê³¼ ê°€ì¥ ìœ ì‚¬í•œ ê³¼ê±° ì¼ë´‰ í˜¹ì€ 30ë¶„ë´‰ì„ ê³„ì‚°í•´ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤.
        </div>
        <!-- Add a toggle for 1D and 30M chart data -->
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="chartType" id="oneDayChart_ko" value="1d" checked>
          <label class="form-check-label" for="oneDayChart_ko">ì¼ë´‰</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="chartType" id="thirtyMinChart_ko" value="30m">
          <label class="form-check-label" for="thirtyMinChart_ko">30ë¶„ë´‰</label>
        </div>
        <div>
            <label for="topKChartRange_ko">ì¡°íšŒí•  ìƒìœ„ ì°¨íŠ¸ ê²°ê³¼ ìˆ˜ (5-20): </label>
            <input type="range" id="topKChartRange_ko" name="topKChart" min="5" max="20" value="5">
            <span id="topKChartValue_ko">5</span>
        </div>
        <div>
            <div style="text-align: center;"> <!-- Added inline CSS for center alignment -->
                <p><strong>í˜„ì¬ ì°¨íŠ¸ ì¢…ê°€ ì›€ì§ì„</strong></p>
            </div>
            <div id="currentPatternInfo_ko"></div>
            <div class="chart" id="currentPatternChart_ko"></div>
        </div>
        <div>
            <button type="button" id="searchChartButton_ko" class="btn btn-success">ê²€ìƒ‰</button>
        </div>
        <br>
        <div id="chartLoading_ko" class="text-center my-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden"></span>
            </div>
        </div>
        <div id="chartResults_ko"></div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script type="text/javascript">
    // Function to toggle between English and Korean sections
    function toggleLanguageSection() {
        var selectedLanguage = document.querySelector('input[name="languageToggle"]:checked').value;

        // Clear the chart results when toggling between languages
        chartDataStorage_en = {}
        chartDataStorage_ko = {}
        clearChartResults();

        if (selectedLanguage === 'en') {
            chartDataStorage_ko = {}; // Clear Korean chart data storage
            document.getElementById("englishSection").style.display = "block";
            document.getElementById("koreanSection").style.display = "none";
            document.getElementById("englishChartSection").style.display = "block";
            document.getElementById("koreanChartSection").style.display = "none";
        } else {
            chartDataStorage_en = {}; // Clear English chart data storage
            document.getElementById("englishSection").style.display = "none";
            document.getElementById("koreanSection").style.display = "block";
            document.getElementById("englishChartSection").style.display = "none";
            document.getElementById("koreanChartSection").style.display = "block";
        }

        // Fetch and display the current chart pattern based on the language toggle
        fetchAndPlotCurrentPattern(selectedLanguage);
    }

    // Add event listeners to the language toggle radio buttons
    document.querySelectorAll('input[name="languageToggle"]').forEach((elem) => {
        elem.addEventListener('change', toggleLanguageSection);
    });

    // Initialize the page with the correct section shown based on the default selected language
    window.onload = function() {
        toggleLanguageSection();  // Call the function on page load
        fetchAndPlotCurrentPattern('en');  // Fetch current chart data when the page loads
    };

    var chartDataStorage_en = {};
    var chartDataStorage_ko = {};


    // Function to get CSRF token from cookies
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    // Search functionality for English
    if (document.getElementById("searchButton_eng") !== null) {
        document.getElementById("searchButton_eng").addEventListener("click", function() {
            var chartCurrency = document.querySelector('input[name="chartCurrency"]:checked').value;  // Get chart currency
            document.getElementById("loading_eng").style.display = "block";
            var newsText = document.getElementById("newsText_eng").value;
            var topK = document.getElementById("topKRange_eng").value;

            var searchNewsUrl = "{% url 'aiphabtc:news_similarity' %}";
            var csrfToken = getCookie('csrftoken');

            fetch(searchNewsUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken
                },
                body: JSON.stringify({
                    news_text: newsText,
                    top_k: topK,
                    chart_type: chartCurrency,
                    language: "en"  // Specify English
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log("English data received:", data);
                var resultsContainer = document.getElementById("results_eng");
                resultsContainer.innerHTML = '';  // Clear previous results

                data.results.forEach(function(result, index) {
                    chartDataStorage_en[index] = {
                        chart_data_30m: result.chart_data_30m,
                        chart_data_1d: result.chart_data_1d,
                    };

                    var resultDiv = document.createElement('div');
                    resultDiv.className = 'result';
                    resultDiv.innerHTML = `
                        <h5> Rank ${index + 1} </h5>
                        <p>${result.text}</p>
                        <p><strong>Contextual Similarity:</strong> ${result.similarity}%</p>
                        <p><strong>Date:</strong> ${result.date}</p>
                        <button class="btn btn-secondary btn-sm" onclick="updateChart('chart${index}', 'chart_data_30m', '${chartCurrency}', 'en')">30m Chart</button>
                        <button class="btn btn-secondary btn-sm" onclick="updateChart('chart${index}', 'chart_data_1d', '${chartCurrency}', 'en')">1d Chart</button>
                        <div class="chart" id="en_chart${index}"></div>
                    `;
                    resultsContainer.appendChild(resultDiv);
                    updateChart(`chart${index}`, 'chart_data_1d', chartCurrency, 'en');  // Default plot 1d chart
                });
                document.getElementById("loading_eng").style.display = "none";
            })
            .catch(error => {
                console.error("Error fetching news similarity results:", error);
                document.getElementById("loading_eng").style.display = "none";
            });
        });
    }

    // Search functionality for Korean
    if (document.getElementById("searchButton") !== null) {
        document.getElementById("searchButton").addEventListener("click", function() {
            var chartCurrency = document.querySelector('input[name="chartCurrency"]:checked').value;  // Get chart currency
            document.getElementById("loading").style.display = "block";
            var newsText = document.getElementById("newsText").value;
            var topK = document.getElementById("topKRange").value;

            var searchNewsUrl = "{% url 'aiphabtc:news_similarity' %}";
            var csrfToken = getCookie('csrftoken');

            fetch(searchNewsUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken
                },
                body: JSON.stringify({
                    news_text: newsText,
                    top_k: topK,
                    chart_type: chartCurrency,
                    language: "ko"  // Specify Korean
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log("Korean data received:", data);
                var resultsContainer = document.getElementById("results");
                resultsContainer.innerHTML = '';  // Clear previous results

                data.results.forEach(function(result, index) {
                    chartDataStorage_ko[index] = {
                        chart_data_30m: result.chart_data_30m,
                        chart_data_1d: result.chart_data_1d,
                    };

                    var resultDiv = document.createElement('div');
                    resultDiv.className = 'result';
                    resultDiv.innerHTML = `
                        <h5> Rank ${index + 1} </h5>
                        <p>${result.text}</p>
                        <p><strong>ë¬¸ë§¥í˜• ìœ ì‚¬ë„:</strong> ${result.similarity}%</p>
                        <p><strong>ë‚ ì§œ:</strong> ${result.date}</p>
                        <button class="btn btn-secondary btn-sm" onclick="updateChart('chart${index}', 'chart_data_30m', '${chartCurrency}', 'ko')">30m Chart</button>
                        <button class="btn btn-secondary btn-sm" onclick="updateChart('chart${index}', 'chart_data_1d', '${chartCurrency}', 'ko')">1d Chart</button>
                        <div class="chart" id="ko_chart${index}"></div>
                    `;
                    resultsContainer.appendChild(resultDiv);
                    updateChart(`chart${index}`, 'chart_data_1d', chartCurrency, 'ko');  // Default plot 1d chart
                });
                document.getElementById("loading").style.display = "none";
            })
            .catch(error => {
                console.error("Error fetching news similarity results:", error);
                document.getElementById("loading").style.display = "none";
            });
        });
    }


    // Search functionality for chart patterns (English)
    if (document.getElementById("searchChartButton_en") !== null) {
        document.getElementById("searchChartButton_en").addEventListener("click", function() {
            chartDataStorage = {}
            var chartCurrency = document.querySelector('input[name="chartCurrency"]:checked').value;
            document.getElementById("chartLoading_en").style.display = "block";
            var topK = document.getElementById("topKChartRange_en").value;
            var chartType = document.querySelector('input[name="chartType"]:checked').value;

            var searchChartUrl = `/aiphabtc/chart_similarity/${chartType}/`;  // Dynamic URL based on chart type
            var csrfToken = getCookie("csrftoken");

            fetch(searchChartUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken
                },
                body: JSON.stringify({
                    top_k: topK,
                    chart_currency:chartCurrency
                }),
            })
            .then(response => response.json())
            .then(data => {
                var resultsContainer = document.getElementById("chartResults_en");
                resultsContainer.innerHTML = '';  // Clear previous results

                data.results.forEach(function(result, index) {
                    var chartId = `chartCombined${index}`;  // Define chartId for combined chart
                    var resultDiv = document.createElement('div');
                    resultDiv.className = 'result';
                    resultDiv.innerHTML = `
                        <h5> Pattern Rank ${index + 1}</h5>
                        <div class="chart" id="${chartId}"></div>
                    `;
                    resultsContainer.appendChild(resultDiv);
                    // Plot both the start and end of the chart pattern
                    plotCombinedChartPattern(chartId, result.date_start, result.chart_data_start, result.date_end, result.chart_data_end, chartCurrency);
                });
                document.getElementById("chartLoading_en").style.display = "none";
            })
            .catch(error => {
                console.error("Error fetching chart pattern results:", error);
                document.getElementById("chartLoading_en").style.display = "none";
            });
        });
    }

    // Search functionality for chart patterns (Korean)
    if (document.getElementById("searchChartButton_ko") !== null) {
        document.getElementById("searchChartButton_ko").addEventListener("click", function() {
            var chartCurrency = document.querySelector('input[name="chartCurrency"]:checked').value;
            document.getElementById("chartLoading_ko").style.display = "block";
            var topK = document.getElementById("topKChartRange_ko").value;
            var chartType = document.querySelector('input[name="chartType"]:checked').value;

            var searchChartUrl = `/aiphabtc/chart_similarity/${chartType}/`;  // Dynamic URL based on chart type
            var csrfToken = getCookie("csrftoken");

            fetch(searchChartUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken
                },
                body: JSON.stringify({
                    top_k: topK,
                    chart_currency: chartCurrency
                }),
            })
            .then(response => response.json())
            .then(data => {
                var resultsContainer = document.getElementById("chartResults_ko");
                resultsContainer.innerHTML = '';  // Clear previous results

                data.results.forEach(function(result, index) {
                    var chartId = `chartCombined${index}`;  // Define chartId for combined chart
                    var resultDiv = document.createElement('div');
                    resultDiv.className = 'result';
                    resultDiv.innerHTML = `
                        <h5> íŒ¨í„´ ìˆœìœ„ ${index + 1}</h5>
                        <div class="chart" id="${chartId}"></div>
                    `;
                    resultsContainer.appendChild(resultDiv);

                    // Plot both the start and end of the chart pattern
                    plotCombinedChartPattern(chartId, result.date_start, result.chart_data_start, result.date_end, result.chart_data_end, chartCurrency);
                });
                document.getElementById("chartLoading_ko").style.display = "none";
            })
            .catch(error => {
                console.error("Error fetching chart pattern results:", error);
                document.getElementById("chartLoading_ko").style.display = "none";
            });
        });
    }

    // Function to clear the chart container before re-plotting
    function clearPlot(chartDiv) {
        if (chartDiv) {
            Plotly.purge(chartDiv);  // Completely remove the old chart
        }
    }

    // Update chart function with clearing old chart
    function updateChart(chartId, chartDataType, chartCurrency, language) {
        // Use the appropriate prefix for chart IDs based on the language
        var actualChartId = language === 'en' ? `en_${chartId}` : `ko_${chartId}`;
        var chartDiv = document.getElementById(actualChartId);

        if (!chartDiv) {
            console.error(`Chart div with ID "${actualChartId}" not found.`);
            return;
        }

        var index = chartId.replace('chart', '');  // Extract index from chartId
        var chartData = language === 'en' ? chartDataStorage_en[index][chartDataType] : chartDataStorage_ko[index][chartDataType];  // Get the correct chart data

        // Clear previous chart if any
        clearPlot(chartDiv);

        // Validate the chart data
        if (!chartData || !Array.isArray(chartData.x) || !Array.isArray(chartData.y) || chartData.x.length !== chartData.y.length) {
            console.error("Invalid data format for chart", chartData);
            return;
        }

        console.log(`Updating chart for ${actualChartId} with data:`, chartData);

        // Plot the chart with Plotly
        Plotly.newPlot(chartDiv, [{
            type: 'scatter',
            mode: 'lines',
            x: chartData.x,
            y: chartData.y,
        }], {
            title: 'Bitcoin Price Chart',
            xaxis: { title: 'Time' },
            yaxis: { title: `BTC-${chartCurrency}` },
        });
    }



    // Function to fetch and plot current chart pattern
    function fetchAndPlotCurrentPattern(selectedLanguage) {
        var chartType = document.querySelector('input[name="chartType"]:checked').value;
        var chartCurrency = document.querySelector('input[name="chartCurrency"]:checked').value;  // Get chart currency
        var csrfToken = getCookie("csrftoken");

        // Set chart IDs dynamically based on selected language
        var chartId = selectedLanguage === 'en' ? "currentPatternChart_en" : "currentPatternChart_ko";

        fetch(`/aiphabtc/get_current_chart_pattern/?chart_currency=${chartCurrency}&chart_type=${chartType}`, {
            method: "GET",
            headers: {
                "X-CSRFToken": csrfToken
            },
        })
        .then(response => response.json())
        .then(data => {
            // Fetch correct pattern data based on chart type
            var currentPatternData = data.current_pattern;

            // Log chart data to ensure it's correctly fetched
            // console.log(`Chart data for ${selectedLanguage}:`, currentPatternData);

            plotChartPattern(chartId, currentPatternData.dates, currentPatternData.close, chartCurrency, 'rgba(0, 123, 255, 1)');
        })
        .catch(error => {
            console.error("Error fetching current chart pattern:", error);
        });
    }

    // Add event listeners for chart currency changes
    document.querySelectorAll('input[name="chartCurrency"]').forEach((elem) => {
        elem.addEventListener('change', function() {
            var selectedLanguage = document.querySelector('input[name="languageToggle"]:checked').value;
            fetchAndPlotCurrentPattern(selectedLanguage);  // Re-fetch and re-plot the chart when currency is changed
        });
    });


    // Function to plot chart patterns
    function plotChartPattern(chartId, xData, yData, chartCurrency, lineColor) {
        var chartDiv = document.getElementById(chartId);
        if (!chartDiv) {
            console.error(`Chart div with ID "${chartId}" not found.`);
            return;
        }

        // Ensure xData and yData are non-empty
        if (!xData || !yData || xData.length === 0 || yData.length === 0) {
            chartDiv.innerHTML = '<p>ì°¨íŠ¸ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤ (Chart data is empty)</p>';
            return;
        }

        Plotly.newPlot(chartDiv, [
            {
                type: 'scatter',
                mode: 'lines',
                x: xData,
                y: yData,
                line: { color: lineColor }
            }
        ], {
            xaxis: { title: 'Time' },
            yaxis: { title: `BTC-${chartCurrency}` }
        });
    }


    // Combine and plot the start and end chart pattern in a single chart
    function plotCombinedChartPattern(chartId, startDate, startData, endDate, endData, chartCurrency) {
        var chartDiv = document.getElementById(chartId);
        if (!chartDiv) {
            console.error(`Chart div with ID "${chartId}" not found.`);
            return;
        }

        // Ensure that startDate, startData, endDate, and endData are valid arrays
        if (!Array.isArray(startDate) || !Array.isArray(startData) || !Array.isArray(endDate) || !Array.isArray(endData)) {
            console.error(`Invalid chart data for chart ID "${chartId}"`);
            chartDiv.innerHTML = '<p>Invalid or missing chart data</p>';
            return;
        }

        // Combine x-axis (dates) and y-axis (prices) for start and end
        var combinedX = startDate.concat(endDate);
        var combinedY = startData.concat(endData);

        // Define traces for start and end data with different colors
        var startTrace = {
            type: 'scatter',
            mode: 'lines',
            x: startDate,
            y: startData,
            line: { color: 'rgba(255, 99, 132, 1)' },  // Red color for Pattern Start
            name: 'Pattern Start'
        };

        var endTrace = {
            type: 'scatter',
            mode: 'lines',
            x: endDate,
            y: endData,
            line: { color: 'rgba(75, 192, 192, 1)' },  // Blue color for Pattern End
            name: 'Pattern End'
        };

        // Plot both traces on the same chart
        Plotly.newPlot(chartDiv, [startTrace, endTrace], {
            xaxis: { title: 'Time' },
            yaxis: { title: `BTC-${chartCurrency}` },
            title: 'Combined Pattern Start and End',
            showlegend: true  // Display the legend
        });
    }



    // Listen for changes to the chart type radio buttons and re-plot the current chart pattern
    document.querySelectorAll('input[name="chartType"]').forEach((elem) => {
        elem.addEventListener('change', function() {
            var selectedLanguage = document.querySelector('input[name="languageToggle"]:checked').value;
            fetchAndPlotCurrentPattern(selectedLanguage);
        });
    });


    // Clear chart results when switching between languages to avoid displaying old results
    function clearChartResults() {
        const enChartContainers = document.querySelectorAll('.chart[id^="en_chart"]');
        const koChartContainers = document.querySelectorAll('.chart[id^="ko_chart"]');

        enChartContainers.forEach(chartDiv => clearPlot(chartDiv));
        koChartContainers.forEach(chartDiv => clearPlot(chartDiv));
    }



    // Update the displayed value for the slider (only if element exists)
    var topKChartRange_en = document.getElementById("topKChartRange_en");
    if (topKChartRange_en) {
        topKChartRange_en.addEventListener("input", function() {
            document.getElementById("topKChartValue_en").innerText = this.value;
        });
    }

    var topKChartRange_ko = document.getElementById("topKChartRange_ko");
    if (topKChartRange_ko) {
        topKChartRange_ko.addEventListener("input", function() {
            document.getElementById("topKChartValue_ko").innerText = this.value;
        });
    }

    var topKRange = document.getElementById("topKRange");
    if (topKRange) {
        topKRange.addEventListener("input", function() {
            document.getElementById("topKValue").innerText = this.value;
        });
    }

    var topKRange_eng = document.getElementById("topKRange_eng");
    if (topKRange_eng) {
        topKRange_eng.addEventListener("input", function() {
            document.getElementById("topKValue_eng").innerText = this.value;
        });
    }
</script>
{% endblock %}
