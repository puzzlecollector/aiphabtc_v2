{% extends 'base.html' %}

{% block head %}
{{ block.super }}
<style>
    .ql-align-center {
        text-align: center;
    }

    .ql-align-right {
        text-align: right;
    }

    .ql-align-justify {
        text-align: justify;
    }
    .custom-form-label { font-weight: bold; }
    .form-control { border-radius: 0.25rem; }
    .btn-primary { background-color: #007bff; border-color: #007bff; }
    .editor-container img {
        max-width: 100%;
        height: auto;
    }
    #currentPrice { margin-top: 0.5rem; font-weight: bold; }
    .post-form { background: #f9f9f9; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .editor-container { background: white; }
    .market-info { display: flex; justify-content: space-between; align-items: center; }
    .duration-range, .price-range { display: flex; gap: 10px; align-items: center; }
    .final-verdict { display: flex; gap: 20px; align-items: center; }
    .final-verdict input { margin-top: 0; }
    .responsive-video {
        width: 100%;
        height: 450px; /* For video tags, ensures proper aspect ratio */
        max-width: 800px; /* Optional: limits video size */
        display: block;
        margin: auto;
    }
</style>
{% endblock %}


{% block content %}
<div class="container my-5">
    <h2 class="text-center mb-4">Create Post</h2>
    <form method="post" class="post-form">
        {% csrf_token %}
        <!-- Error Display -->
        {% if form.errors %}
            <div class="alert alert-danger" role="alert">
                <ul>
                {% for field in form %}
                    {% if field.errors %}
                    <li><strong>{{ field.label }}:</strong> {{ field.errors }}</li>
                    {% endif %}
                {% endfor %}
                </ul>
            </div>
        {% endif %}

        <div class="form-group">
            <label for="subject" class="custom-form-label">Title</label>
            <input type="text" class="form-control" name="subject" id="subject" value="{{ form.subject.value|default_if_none:'' }}">
        </div>
        <div class="form-group">
            <label for="content" class="custom-form-label d-block">Content</label>
            <div id="editor" class="editor-container" style="height: 300px;">{{ form.content.value|default_if_none:''|safe }}</div>
            <textarea class="form-control" name="content" id="content" style="display: none;">{{ form.content.value|default_if_none:'' }}</textarea>
        </div>
        {% if board_name == "perceptive_board" %}
        <div class="market-info">
            <div class="form-group">
                <label for="market_type" class="custom-form-label">Market Type:</label>
                {{ form.market_type }}
            </div>
            <p id="currentPrice" style="font-weight: bold;"></p>
        </div>
        <div class="form-group">
            <label for="market" class="custom-form-label">Ticker:</label>
            {{ form.market }}
        </div>
        <div class="duration-range">
            <div class="form-group">
                <label class="custom-form-label">Prediction Duration:</label>
                {{ form.duration_from }}
            </div>
            <div class="form-group">
                <label class="custom-form-label">-</label>
                {{ form.duration_to }}
            </div>
        </div>
        <div class="price-range">
            <div class="form-group">
                <label class="custom-form-label">Prediction Price Range:</label>
                {{ form.price_lower_range }}
            </div>
            <div class="form-group">
                <label class="custom-form-label">-</label>
                {{ form.price_upper_range }}
            </div>
        </div>
        <div class="final-verdict">
            <label class="custom-form-label">Overall Sentiment:</label>
            {{ form.final_verdict }}
        </div>
        {% endif %}
        <button type="submit" class="btn btn-primary mt-3">Post</button>
    </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline', 'strike'],
                ['blockquote', 'code-block'],
                [{ 'header': 1 }, { 'header': 2 }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'script': 'sub'}, { 'script': 'super' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                [{ 'direction': 'rtl' }],
                [{ 'size': ['small', false, 'large', 'huge'] }],
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'font': [] }],
                [{ 'align': [] }],
                ['clean'],
                ['link', 'image', 'video'],
                ['formula']
            ],
            formula: true
        }
    });

    // Custom blot for embedding videos
    var BlockEmbed = Quill.import('blots/block/embed');
    class VideoBlot extends BlockEmbed {
        static create(value) {
            let node = document.createElement('iframe');
            node.setAttribute('src', value);
            node.setAttribute('frameborder', '0');
            node.setAttribute('allowfullscreen', 'true');
            node.setAttribute('width', '100%');
            node.style.height = '450px'; // Set height to maintain aspect ratio
            return node;
        }

        static value(node) {
            return node.getAttribute('src');
        }
    }

    VideoBlot.blotName = 'video';
    VideoBlot.tagName = 'iframe';
    Quill.register(VideoBlot);

    // Load existing content into Quill
    const contentField = document.querySelector('textarea[name="content"]');
    if (contentField) {
        quill.clipboard.dangerouslyPasteHTML(contentField.value);
    }

    // Ensure form submission carries over the rich text content
    var form = document.querySelector('form');
    form.onsubmit = function() {
        contentField.value = quill.root.innerHTML;
    };

    // Variables for market type, ticker, and price
    var marketTypeDropdown = document.querySelector('#id_market_type');
    var marketDropdown = document.querySelector('#id_market');
    var currentPriceDisplay = document.getElementById('currentPrice');

    // Function to fetch and update tickers based on selected market type
    function updateTickers(marketType) {
        fetch(`/aiphabtc/get-tickers/${marketType}/`)
            .then(response => response.json())
            .then(data => {
                marketDropdown.innerHTML = '';
                data.tickers.forEach(ticker => {
                    var option = document.createElement('option');
                    option.value = ticker;
                    option.textContent = ticker;
                    marketDropdown.appendChild(option);
                });
                // Fetch price for the first ticker by default
                fetchCurrentPrice(marketDropdown.value, marketType);
            });
    }


    // Fetching and displaying the current price
    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // Function to fetch and display the current price
    function fetchCurrentPrice(market, marketType) {
        fetch(`/aiphabtc/get-current-price/${marketType}/${market}/`)
            .then(response => response.json())
            .then(data => {
                const currency = marketType === 'KRW' ? 'KRW' : 'USDT';
                currentPriceDisplay.textContent = 'Current Price: ' + numberWithCommas(data.price) + ' ' + currency;
            })
            .catch(error => console.error('Error fetching current price:', error));
    }

    // Listen for changes in the market type dropdown
    marketTypeDropdown.addEventListener('change', function() {
        updateTickers(marketTypeDropdown.value);
    });

    // Listen for changes in the ticker dropdown
    marketDropdown.addEventListener('change', function() {
        fetchCurrentPrice(marketDropdown.value, marketTypeDropdown.value);
    });

    // Load initial tickers for the default market type
    updateTickers(marketTypeDropdown.value);

    // Initial fetch of current price for the default market and ticker
    fetchCurrentPrice(marketDropdown.value, marketTypeDropdown.value);
});
</script>
{% endblock %}

